<body id="itrf">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="./output.css" rel="stylesheet" />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
  />
  <section
    data-theme="dark"
    class="mt-20 flex items-center flex-col gap-10 min-h-screen bg-base-100"
  >
    <h1 class="text-center text-3xl font-extrabold text-white">
      Soulbound Token (ERC1155) - Admin
    </h1>
    <div role="tablist" class="tabs tabs-boxed">
      <a
        role="tab"
        id="mint-tab"
        class="tab tab-active transition-all duration-200"
      >
        Mint
      </a>
      <a role="tab" id="batch-tab" class="tab transition-all duration-200">
        Batch Mint
      </a>
      <a role="tab" id="transfer-tab" class="tab transition-all duration-200">
        Set URI
      </a>
      <a role="tab" id="burn-tab" class="tab transition-all duration-200">
        Burn
      </a>
      <a role="tab" id="burn-tab" class="tab transition-all duration-200">
        Batch Burn
      </a>
      <a role="tab" id="transfer-tab" class="tab transition-all duration-200">
        Transfer ownership
      </a>
    </div>
    <div id="tab-1" class="card w-96 bg-base-100 shadow-xl">
      <form id="mint_form" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <label for="wallet_address">Wallet address</label>
          <input
            type="text"
            id="wallet_address"
            name="wallet_address"
            placeholder="Enter address"
            class="input input-bordered w-full max-w-xs"
            required
          />

          <label for="mint_id">Token ID</label>
          <input
            type="number"
            id="mint_id"
            name="mint_id"
            placeholder="Enter token ID"
            class="input input-bordered w-full max-w-xs"
            required
          />

          <label for="mint_amoutn">Amount</label>
          <input
            type="number"
            id="mint_amoutn"
            name="mint_amoutn"
            placeholder="Enter amount of token"
            class="input input-bordered w-full max-w-xs"
            required
          />
        </div>
        <button class="btn btn-primary">Mint</button>
      </form>
    </div>

    <div id="tab-2" class="card w-96 bg-base-100 shadow-xl hidden">
      <form id="batch_form" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <div class="flex flex-col gap-2">
            <label for="address">Address</label>
            <input
              type="text"
              id="address"
              name="address"
              placeholder="Enter address"
              class="input input-bordered w-full max-w-xs"
              required
            />
          </div>
          <label for="mint_ids">Token IDs</label>
          <textarea
            id="mint_ids"
            name="mint_ids"
            class="textarea textarea-bordered min-h-36 max-h-96"
            placeholder="Enter metadata links"
          ></textarea>
          <label for="mint_amounts">Token amounts</label>
          <textarea
            id="mint_amounts"
            name="mint_amounts"
            class="textarea textarea-bordered min-h-36 max-h-96"
            placeholder="Enter metadata links"
          ></textarea>
        </div>
        <button class="btn btn-primary">Batch mint</button>
      </form>
    </div>

    <div id="tab-3" class="card w-96 bg-base-100 shadow-xl hidden">
      <form id="set_uri_form" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <label for="uri_id">Token ID</label>
          <input
            type="number"
            id="uri_id"
            name="uri_id"
            placeholder="Enter id"
            class="input input-bordered w-full max-w-xs"
            required
          />
          <label for="uri_usri">Token URI</label>
          <input
            type="text"
            id="uri_usri"
            name="uri_usri"
            placeholder="Enter URI"
            class="input input-bordered w-full max-w-xs"
            required
          />
        </div>
        <button class="btn btn-primary">Set</button>
      </form>
    </div>

    <div id="tab-4" class="card w-96 bg-base-100 shadow-xl hidden">
      <form id="burn_form" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <label for="burn_address">Wallet address</label>
          <input
            type="text"
            id="burn_address"
            name="burn_address"
            placeholder="Enter address"
            class="input input-bordered w-full max-w-xs"
            required
          />

          <label for="burn_id">Token ID</label>
          <input
            type="number"
            id="burn_id"
            name="burn_id"
            placeholder="Enter token ID"
            class="input input-bordered w-full max-w-xs"
            required
          />

          <label for="burn_amount">Amount</label>
          <input
            type="number"
            id="burn_amount"
            name="burn_amount"
            placeholder="Enter amount of token"
            class="input input-bordered w-full max-w-xs"
            required
          />
        </div>
        <button class="btn btn-primary">Burn</button>
      </form>
    </div>

    <div id="tab-5" class="card w-96 bg-base-100 shadow-xl hidden">
      <form id="batch_form" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <div class="flex flex-col gap-2">
            <label for="batch_burn_address">Address</label>
            <input
              type="text"
              id="batch_burn_address"
              name="batch_burn_address"
              placeholder="Enter address"
              class="input input-bordered w-full max-w-xs"
              required
            />
          </div>
          <label for="burn_ids">Token IDs</label>
          <textarea
            id="burn_ids"
            name="burn_ids"
            class="textarea textarea-bordered min-h-36 max-h-96"
            placeholder="Enter metadata links"
          ></textarea>
          <label for="burn_amounts">Token amounts</label>
          <textarea
            id="burn_amounts"
            name="burn_amounts"
            class="textarea textarea-bordered min-h-36 max-h-96"
            placeholder="Enter metadata links"
          ></textarea>
        </div>
        <button class="btn btn-primary">Batch mint</button>
      </form>
    </div>

    <div id="tab-6" class="card w-96 bg-base-100 shadow-xl hidden">
      <form id="transfer_ownership" class="card-body flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <label for="t_ownership"
            >Enter the address to whom you want to transfer ownership or leave
            blank to block access permanently (renounce ownership)</label
          >
          <input
            type="text"
            id="t_ownership"
            name="t_ownership"
            placeholder="Enter address or leave blank"
            class="input input-bordered w-full max-w-xs"
          />
        </div>
        <button class="btn btn-primary">Transfer ownership</button>
      </form>
    </div>
  </section>

  <script>
    const tabs = document.querySelectorAll(".tab");
    const cards = document.querySelectorAll(".card");

    tabs.forEach((tab, index) => {
      tab.addEventListener("click", () => {
        // Remove 'tab-active' class from all tabs
        tabs.forEach((tab) => tab.classList.remove("tab-active"));
        // Add 'tab-active' class to the clicked tab
        tab.classList.add("tab-active");

        // Hide all cards
        cards.forEach((card) => card.classList.add("hidden"));
        // Show the corresponding card (index + 1 because index is 0-based)
        document.getElementById(`tab-${index + 1}`).classList.remove("hidden");
      });
    });
  </script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.umd.min.js"
    type="application/javascript"
  ></script>
  <script>
    const abi = [
      {
        inputs: [
          {
            internalType: "string",
            name: "_name",
            type: "string",
          },
          {
            internalType: "string",
            name: "_symbol",
            type: "string",
          },
        ],
        stateMutability: "payable",
        type: "constructor",
      },
      {
        anonymous: false,
        inputs: [
          {
            indexed: true,
            internalType: "address",
            name: "user",
            type: "address",
          },
          {
            indexed: true,
            internalType: "address",
            name: "newOwner",
            type: "address",
          },
        ],
        name: "OwnershipTransferred",
        type: "event",
      },
      {
        anonymous: false,
        inputs: [
          {
            indexed: true,
            internalType: "address",
            name: "from",
            type: "address",
          },
          {
            indexed: true,
            internalType: "address",
            name: "to",
            type: "address",
          },
          {
            indexed: true,
            internalType: "uint256",
            name: "id",
            type: "uint256",
          },
        ],
        name: "Transfer",
        type: "event",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "owner",
            type: "address",
          },
        ],
        name: "balanceOf",
        outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "uint256",
            name: "id",
            type: "uint256",
          },
        ],
        name: "burn",
        outputs: [],
        stateMutability: "payable",
        type: "function",
      },
      {
        inputs: [],
        name: "name",
        outputs: [{ internalType: "string", name: "", type: "string" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "owner",
        outputs: [{ internalType: "address", name: "", type: "address" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "uint256",
            name: "id",
            type: "uint256",
          },
        ],
        name: "ownerOf",
        outputs: [
          {
            internalType: "address",
            name: "owner",
            type: "address",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address[]",
            name: "to",
            type: "address[]",
          },
          {
            internalType: "string[]",
            name: "uris",
            type: "string[]",
          },
        ],
        name: "safeBatchMint",
        outputs: [],
        stateMutability: "payable",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "to",
            type: "address",
          },
          { internalType: "string", name: "uri", type: "string" },
        ],
        name: "safeMint",
        outputs: [],
        stateMutability: "payable",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "bytes4",
            name: "interfaceId",
            type: "bytes4",
          },
        ],
        name: "supportsInterface",
        outputs: [{ internalType: "bool", name: "", type: "bool" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "symbol",
        outputs: [{ internalType: "string", name: "", type: "string" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "uint256",
            name: "tokenId",
            type: "uint256",
          },
        ],
        name: "tokenURI",
        outputs: [{ internalType: "string", name: "", type: "string" }],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "newOwner",
            type: "address",
          },
        ],
        name: "transferOwnership",
        outputs: [],
        stateMutability: "payable",
        type: "function",
      },
    ];

    // tests chain
    const privateKey =
      "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
    const provider = ethers.getDefaultProvider("http://localhost:8545/");

    const contractAddress = "0x5fbdb2315678afecb367f032d93f642f64180aa3";
    const walletWithProvider = new ethers.Wallet(privateKey, provider);

    const contract = new ethers.Contract(contractAddress, abi, provider);
    const connectContract = contract.connect(walletWithProvider);
    // tests chain
  </script>
  <script
    type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/toastify-js"
  ></script>
  <script>
    const mintForm = document.getElementById("mint_form");
    const burnForm = document.getElementById("burn_form");
    const batchForm = document.getElementById("batch_form");
    const transferOwnership = document.getElementById("transfer_ownership");

    transferOwnership.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(transferOwnership);
      const to = formData.get("t_ownership");

      if (!to) {
        // ничего не ввел
        await connectContract.transferOwnership(
          "0x0000000000000000000000000000000000000000"
        );
        console.log(await connectContract.owner());
      } else {
        if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
          Toastify({
            text: `Wrong address: ${to}`,
            className: "error",
            position: "center",
            gravity: "bottom",
          }).showToast();
        }
        console.log(await connectContract.owner());
        error = true;
        if (!error) {
          await connectContract.transferOwnership(to);

          console.log(await connectContract.owner());
        }
      }
    });

    mintForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(mintForm);
      const uri = formData.get("metadata_link");
      const to = formData.get("wallet_address");

      if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
        Toastify({
          text: `Wrong address: ${to}`,
          className: "error",
          position: "center",
          gravity: "bottom",
        }).showToast();
        error = true;
      }
      if (!error) {
        await connectContract.safeMint(to, uri);
      }
    });

    // сжигает в локалке
    burnForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(burnForm);
      const id = formData.get("id");

      await connectContract.burn(id);
    });

    batchForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(batchForm);
      let walletsData = formData.get("addresses");
      const walletsArray = walletsData
        .split("\n")
        .map((wallet) => wallet.trim())
        .filter((wallet) => wallet.trim() !== "");

      walletsArray.forEach((wallet, index) => {
        if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
          Toastify({
            text: `Wrong address: ${wallet}`,
            className: "error",
            position: "center",
            gravity: "bottom",
          }).showToast();
          error = true;
        }
      });

      // const uniqueWalletsArray = Array.from(new Set(walletsArray)); // без дубликатов массив

      const metadata_links = formData.get("metadata_uri");
      const urisArray = metadata_links
        .split("\n")
        .map((uri) => uri.trim())
        .filter((uri) => uri.trim() !== "");

      if (walletsArray.length != urisArray.length) {
        Toastify({
          text: `The number of addresses and links did not match! Check again, there may be duplicates!`,
          className: "error",
          position: "center",
          gravity: "bottom",
        }).showToast();
        error = true;
      }

      if (!error) {
        await connectContract.safeBatchMint(walletsArray, urisArray);

        // собираем все события контракта и там можно пройтись по массиву
        // и вывести owner (topics[2]), id (topics[3]), uri tokenURI(topics[3])
        // обратиться к uri и збрать json выводя name, description, image
        const filter = await connectContract.queryFilter("Transfer");

        filter.forEach(async (event) => {
          const topics = event.topics;
          const topicToWallet = topics[2].slice(-40);
          // topicToWallet === walletWithProvider.address.slice(-40).toLowerCase()
          console.log(await connectContract.tokenURI(topics[3]));
        });
      }
    });
  </script>
</body>
